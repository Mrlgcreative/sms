<?php
// Test direct de l'export CSV amélioré
session_start();

// Simuler une session admin
$_SESSION['user_id'] = 1;
$_SESSION['username'] = 'admin';
$_SESSION['role'] = 'admin';

// Inclure la configuration
require_once 'config/database.php';

try {
    // Connexion à la base de données
    $mysqli = new mysqli(DB_HOST, DB_USER, DB_PASS, DB_NAME);

    if ($mysqli->connect_error) {
        throw new Exception("Erreur de connexion: " . $mysqli->connect_error);
    }

    // Récupérer les paiements
    $query = "SELECT p.*, e.nom as eleve_nom, e.prenom as eleve_prenom, 
                     c.nom as classe_nom, o.nom as option_nom, e.section,
                     f.description as frais_description,
                     MONTH(p.payment_date) as mois_numero
              FROM paiements_frais p
              LEFT JOIN eleves e ON p.eleve_id = e.id
              LEFT JOIN classes c ON e.classe_id = c.id
              LEFT JOIN options o ON e.option_id = o.id
              LEFT JOIN frais f ON p.frais_id = f.id
              ORDER BY p.payment_date DESC
              LIMIT 50"; // Limiter pour le test
    
    $result = $mysqli->query($query);
    $paiements = [];
    
    if ($result) {
        while ($row = $result->fetch_assoc()) {
            $mois_fr = [
                1 => 'Janvier', 2 => 'Février', 3 => 'Mars', 4 => 'Avril',
                5 => 'Mai', 6 => 'Juin', 7 => 'Juillet', 8 => 'Août',
                9 => 'Septembre', 10 => 'Octobre', 11 => 'Novembre', 12 => 'Décembre'
            ];
            $row['mois'] = $mois_fr[$row['mois_numero']] ?? 'Inconnu';
            $paiements[] = $row;
        }
    }

    // Statistiques
    $total_result = $mysqli->query("SELECT COUNT(*) AS total_paiements, SUM(amount_paid) AS montant_total FROM paiements_frais");
    $totals = $total_result->fetch_assoc();
    $total_paiements = $totals['total_paiements'];
    $montant_total = $totals['montant_total'] ?? 0;
    $mysqli->close();

    // Générer le CSV amélioré
    $filename = 'Rapport_Paiements_Premium_' . date('Y-m-d_H-i-s') . '.csv';
    
    header('Content-Type: text/csv; charset=utf-8');
    header('Content-Disposition: attachment; filename="' . $filename . '"');
    header('Cache-Control: private, max-age=0, must-revalidate');
    header('Pragma: public');

    $output = fopen('php://output', 'w');
    fprintf($output, chr(0xEF).chr(0xBB).chr(0xBF));

    // En-tête premium avec ASCII art
    fputcsv($output, ['╔══════════════════════════════════════════════════════════════════════════╗'], ';');
    fputcsv($output, ['║                      📊 SYSTÈME DE GESTION SCOLAIRE                       ║'], ';');
    fputcsv($output, ['║                        🎓 RAPPORT DES PAIEMENTS 🎓                         ║'], ';');
    fputcsv($output, ['╚══════════════════════════════════════════════════════════════════════════╝'], ';');
    fputcsv($output, [''], ';');
    
    // Informations de génération
    fputcsv($output, ['📅 Date de génération:', date('d/m/Y à H:i:s')], ';');
    fputcsv($output, ['👤 Généré par:', $_SESSION['username'] ?? 'Administrateur'], ';');
    fputcsv($output, ['🏫 Établissement:', 'École de Gestion Scolaire'], ';');
    fputcsv($output, ['📁 Nom du fichier:', $filename], ';');
    fputcsv($output, [''], ';');

    // Section statistiques premium
    fputcsv($output, ['┌─────────────────────────────────────────────────────────────────────────┐'], ';');
    fputcsv($output, ['│                          📈 RÉSUMÉ STATISTIQUE                           │'], ';');
    fputcsv($output, ['├─────────────────────────────────────────────────────────────────────────┤'], ';');
    fputcsv($output, ['│ 📊 Nombre total de paiements:', sprintf('%6d paiements', $total_paiements)], ';');
    fputcsv($output, ['│ 💰 Montant total collecté:', sprintf('%15s $', number_format($montant_total, 2, ',', ' '))], ';');
    
    if ($total_paiements > 0) {
        $moyenne = $montant_total / $total_paiements;
        fputcsv($output, ['│ 💵 Montant moyen par paiement:', sprintf('%11s $', number_format($moyenne, 2, ',', ' '))], ';');
        
        // Calcul de la période
        if (!empty($paiements)) {
            $dates = array_column($paiements, 'payment_date');
            $date_min = min($dates);
            $date_max = max($dates);
            fputcsv($output, ['│ 📅 Période couverte:', 'Du ' . date('d/m/Y', strtotime($date_min)) . ' au ' . date('d/m/Y', strtotime($date_max))], ';');
        }
    }
    
    fputcsv($output, ['└─────────────────────────────────────────────────────────────────────────┘'], ';');
    fputcsv($output, [''], ';');

    // En-têtes des colonnes avec design premium
    fputcsv($output, ['╔════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════────════════════════════════════════────────════────────────╗'], ';');
    fputcsv($output, ['║                                                          🗂️ DONNÉES DÉTAILLÉES DES PAIEMENTS                                                          ║'], ';');
    fputcsv($output, ['╠════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════────────────────────────────────────────────────────────────╣'], ';');
    
    $headers = [
        '🔢 N°', '👤 NOM DE FAMILLE', '👤 PRÉNOM', '🎓 CLASSE', '📋 SECTION',
        '💰 TYPE DE FRAIS', '💵 MONTANT (USD)', '📅 DATE PAIEMENT',
        '📆 MOIS', '🎯 OPTION', '🆔 ID', '🆔 ÉLÈVE', '🆔 FRAIS'
    ];
    
    fputcsv($output, $headers, ';');
    
    // Séparateur
    $separator = [];
    foreach ($headers as $header) {
        $separator[] = str_repeat('─', mb_strlen($header, 'UTF-8'));
    }
    fputcsv($output, $separator, ';');

    // Données avec formatage premium
    $num = 1;
    foreach (array_slice($paiements, 0, 50) as $paiement) { // Limiter à 50 pour le test
        $data = [
            sprintf('%03d', $num),
            strtoupper($paiement['eleve_nom'] ?? ''),
            ucwords(strtolower($paiement['eleve_prenom'] ?? '')),
            $paiement['classe_nom'] ?? '',
            $paiement['section'] ?? '',
            $paiement['frais_description'] ?? '',
            number_format($paiement['amount_paid'], 2, ',', ' ') . ' $',
            date('d/m/Y', strtotime($paiement['payment_date'])),
            $paiement['mois'] ?? '',
            $paiement['option_nom'] ?? '',
            sprintf('#%05d', $paiement['id']),
            sprintf('#%05d', $paiement['eleve_id'] ?? 0),
            sprintf('#%05d', $paiement['frais_id'] ?? 0)
        ];
        fputcsv($output, $data, ';');
        $num++;
    }

    // Séparateur de fin
    fputcsv($output, $separator, ';');
    fputcsv($output, ['╚════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════────────────════────────────────────────────────────╝'], ';');
    fputcsv($output, [''], ';');

    // Total premium
    fputcsv($output, ['┌─────────────────────────────────────────────────────────────────────────┐'], ';');
    fputcsv($output, ['│                          🎯 TOTAL GÉNÉRAL                                │'], ';');
    fputcsv($output, ['├─────────────────────────────────────────────────────────────────────────┤'], ';');
    fputcsv($output, ['│ 💰 MONTANT TOTAL:', '', '', '', '', '', number_format($montant_total, 2, ',', ' ') . ' $', '', '', '✅ ' . $total_paiements . ' paiements'], ';');
    fputcsv($output, ['└─────────────────────────────────────────────────────────────────────────┘'], ';');

    // Footer informatif
    fputcsv($output, [''], ';');
    fputcsv($output, ['ℹ️  INFORMATIONS TECHNIQUES'], ';');
    fputcsv($output, ['────────────────────────────'], ';');
    fputcsv($output, ['🔤 Encodage:', 'UTF-8 avec BOM'], ';');
    fputcsv($output, ['📊 Séparateur:', 'Point-virgule (;)'], ';');
    fputcsv($output, ['📱 Compatible:', 'Excel, LibreOffice, Google Sheets'], ';');
    fputcsv($output, ['🏫 Système:', 'Gestion Scolaire Premium v2.0'], ';');
    fputcsv($output, [''], ';');
    fputcsv($output, ['© 2025 École de Gestion Scolaire - Tous droits réservés'], ';');

    fclose($output);
    
} catch (Exception $e) {
    echo "Erreur : " . $e->getMessage();
}
?>
